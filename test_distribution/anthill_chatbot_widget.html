<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anthill IQ Chatbot Test</title>
    <style>
        /* Modern Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main widget container with enhanced design */
        .chat-widget {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            --primary-color: #2a9a16;
            --primary-dark: #228512;
            --primary-light: #eeffeA;
            --shadow-light: rgba(42, 154, 22, 0.15);
            --shadow-dark: rgba(42, 154, 22, 0.3);
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-light: #f8fafc;
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Define pulse animation for chat toggle */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 15px var(--shadow-light);
                transform: scale(1);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(42, 154, 22, 0);
            }
            100% {
                box-shadow: 0 4px 15px var(--shadow-light);
                transform: scale(1);
            }
        }

        /* Enhanced Chat toggle button */
        .chat-toggle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            box-shadow: 0 4px 20px var(--shadow-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            z-index: 10;
            animation: pulse 2s infinite;
        }

        .chat-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #34b41e, #2a9a16);
            opacity: 0;
            border-radius: 50%;
            transition: opacity 0.3s ease;
        }

        .chat-toggle:hover {
            animation: none;
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow-dark);
        }

        .chat-toggle:hover::before {
            opacity: 1;
        }

        .chat-toggle:active {
            transform: scale(0.95);
            animation: none;
        }

        .chat-toggle-icon {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        /* Enhanced Chat window with modern design */
        .chat-window {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 380px;
            height: 550px;
            border-radius: 20px;
            background-color: white;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.18);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(0, 0, 0, 0.06);
            transform-origin: bottom right;
            z-index: 10000;
        }

        /* Improved hidden state animation with zoom effect */
        .hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Mobile-specific animations */
        @media (max-width: 480px) {
            .chat-window.hidden {
                transform: translateY(100%) !important;
            }
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 480px) {
            .chat-window {
                width: 100%;
                height: 90vh;
                max-height: none;
                bottom: 70px;
                right: 0;
                left: 0;
                border-radius: 10px 10px 0 0;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15);
                transform-origin: bottom center;
            }

            /* Ensure chat toggle stays above other elements */
            .chat-toggle {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 10px;
                right: 10px;
                z-index: 10001;
            }

            /* Adjust chat window animation for mobile */
            .chat-window.hidden {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        /* Modern chat header */
        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            line-height: 1;
            opacity: 0.9;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Enhanced chat messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 22px;
            background-color: var(--bg-light);
            scroll-behavior: smooth;
            background-image: 
                radial-gradient(circle at 25% 15%, rgba(67, 97, 238, 0.03) 1%, transparent 10%),
                radial-gradient(circle at 75% 85%, rgba(67, 97, 238, 0.02) 1%, transparent 10%);
        }

        /* User registration form */
        .user-registration-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 30px;
            background-color: var(--bg-light);
            background-image: 
                radial-gradient(circle at 25% 15%, rgba(42, 154, 22, 0.03) 1%, transparent 10%),
                radial-gradient(circle at 75% 85%, rgba(42, 154, 22, 0.02) 1%, transparent 10%);
        }

        .user-registration-form h4 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 18px;
            text-align: center;
            position: relative;
        }

        .user-registration-form h4:after {
            content: '';
            display: block;
            height: 2px;
            width: 40px;
            background: var(--primary-color);
            margin: 8px auto 0;
            opacity: 0.7;
        }

        .user-registration-form p {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .user-registration-form input {
            width: 100%;
            padding: 14px;
            margin-bottom: 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #f9fafb;
            font-family: inherit;
        }

        .user-registration-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background-color: white;
        }

        .user-registration-form button {
            padding: 14px 20px;
            margin-top: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
        }

        .user-registration-form button:hover {
            background: linear-gradient(135deg, var(--primary-dark), #1c7010);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-dark);
        }

        .user-registration-form button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        /* Improved scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Enhanced message styles */
        .message-wrapper {
            margin-bottom: 18px;
            clear: both;
            width: 100%;
            display: flow-root;
        }

        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 2px;
            font-size: 15px; /* Slightly larger text */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Message bubble styling */
        .bot-message {
            background-color: white;
            color: var(--text-dark);
            float: left;
            border-bottom-left-radius: 4px;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .bot-message a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .bot-message a:hover {
            text-decoration: underline;
        }

        .user-message {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            float: right;
            border-bottom-right-radius: 4px;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        .message-source {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
            display: block;
            text-transform: capitalize;
        }

        .message-source.hidden {
            display: none;
        }

        /* Improved typing indicator */
        .typing-indicator {
            padding: 14px 18px;
            background-color: white;
            border-radius: 18px;
            display: none;
            color: var(--text-light);
            margin-bottom: 10px;
            max-width: 70%;
            float: left;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .typing-indicator::after {
            content: "...";
            animation: dots 1.5s infinite;
            display: inline-block;
            width: 20px;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }

        /* Enhanced booking form with scrolling */
        .booking-form {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
            border-radius: 0 0 20px 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .booking-form::-webkit-scrollbar {
            width: 6px;
        }

        .booking-form::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        .booking-form::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        .booking-form::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .booking-form h4 {
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            position: relative;
        }
        
        .booking-form h4:after {
            content: '';
            display: block;
            height: 2px;
            width: 40px;
            background: var(--primary-color);
            margin: 8px auto 0;
            opacity: 0.7;
        }

        .booking-form input, .booking-form select {
            width: 100%;
            padding: 14px;
            margin-bottom: 14px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #f9fafb;
            font-family: inherit;
        }

        .booking-form input:focus, .booking-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background-color: white;
        }
        
        .booking-form input:disabled, .booking-form select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #f1f3f5;
        }
        
        .booking-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }

        .booking-form button {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
            flex-grow: 1;
            min-width: 100px;
        }

        .booking-form button[type="submit"], .booking-form .submit-button {
            background: #2a9a16;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            display: block !important;
            position: relative;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 1 !important;
        }

        .booking-form button[type="submit"]:hover, .booking-form .submit-button:hover {
            background: #228512;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .booking-form button[type="submit"]:active, .booking-form .submit-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .booking-form button[type="button"] {
            background-color: #f3f4f6;
            color: #4b5563;
            flex-basis: 25%;
        }

        .booking-form button[type="button"]:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
        }
        
        .booking-form #back-button {
            background-color: #6c757d;
            color: white;
        }
        
        .booking-form #back-button:hover {
            background-color: #5a6268;
        }
        
        .booking-form #cancel-booking {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        
        .booking-form #cancel-booking:hover {
            background-color: #e5e7eb;
        }

        /* Enhanced input area */
        .chat-input-area {
            padding: 18px;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
        }

        .chat-input-area textarea {
            flex: 1;
            padding: 15px 18px;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            overflow: hidden;
            outline: none;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.2s ease;
            background-color: #f9fafb;
        }

        .chat-input-area textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background-color: white;
        }

        .chat-input-area button {
            margin-left: 10px;
            padding: 15px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        .chat-input-area button:hover {
            background: linear-gradient(135deg, var(--primary-dark), #1c7010);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-dark);
        }

        .chat-input-area button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        /* Send icon */
        .send-icon {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 2.5;
        }

        /* Enhanced quick reply buttons */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-reply-button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 16px;
            padding: 10px 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .quick-reply-button:hover {
            background: linear-gradient(135deg, var(--primary-dark), #1c7010);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }
        
        .quick-reply-button.cancel {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .quick-reply-button.cancel:hover {
            background: linear-gradient(135deg, #5a6268, #343a40);
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 480px) {
            .chat-window {
                width: 100%;
                height: 90vh;
                max-height: none;
                bottom: 70px;
                right: 0;
                left: 0;
                border-radius: 10px 10px 0 0;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15);
            }

            .chat-toggle {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 10px;
                right: 10px;
            }

            .chat-header {
                padding: 12px 15px;
            }

            .chat-messages {
                padding: 15px;
            }

            .chat-input-area {
                padding: 10px;
            }
            
            .chat-input-area textarea {
                padding: 10px;
                font-size: 14px;
                min-height: 20px;
            }
            
            .chat-input-area button {
                width: 40px;
                height: 40px;
                padding: 8px;
                margin-left: 5px;
            }
            
            .message {
                max-width: 85%;
                font-size: 14px;
                padding: 10px 12px;
                margin-bottom: 8px;
            }
            
            .booking-form {
                padding: 15px;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .booking-form input, .booking-form select {
                padding: 10px;
                margin-bottom: 8px;
                font-size: 14px;
            }
            
            .booking-form button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .user-registration-form {
                padding: 20px;
            }
            
            .user-registration-form input {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .user-registration-form button {
                padding: 12px;
                font-size: 14px;
            }
            
            .quick-replies {
                gap: 5px;
                margin-top: 8px;
            }
            
            .quick-reply-button {
                padding: 8px 10px;
                font-size: 12px;
                margin-bottom: 5px;
                border-radius: 12px;
            }
            
            .map-link, a.map-link {
                font-size: 14px !important;
                padding: 8px !important;
            }
        }
        
        /* Extra small mobile phones */
        @media (max-width: 320px) {
            .chat-window {
                height: 85vh;
                bottom: 65px;
            }
            
            .chat-toggle {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .message {
                max-width: 90%;
                font-size: 13px;
                padding: 8px 10px;
            }
            
            .chat-header h3 {
                font-size: 16px;
            }
            
            .close-button {
                width: 24px;
                height: 24px;
                font-size: 16px;
            }
            
            .quick-reply-button {
                padding: 6px 8px;
                font-size: 11px;
            }
        }
        
        /* Tablet devices */
        @media (min-width: 481px) and (max-width: 768px) {
            .chat-window {
                width: 350px;
                height: 500px;
                right: 10px;
            }
            
            .chat-messages {
                padding: 18px;
            }
            
            .message {
                font-size: 14px;
                padding: 12px 14px;
            }
            
            .booking-form input, .booking-form select {
                padding: 12px;
                margin-bottom: 12px;
            }
        }
        
        /* Landscape orientation for mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .chat-window {
                height: 80vh;
                max-height: 400px;
                width: 85%;
                right: 10px;
                left: auto;
            }
            
            .chat-messages {
                max-height: 50vh;
            }
            
            .booking-form {
                max-height: 70vh;
            }
        }
        
        /* Enhanced styling for message formatting */
        .bot-message ul, .bot-message ol {
            margin-top: 8px;
            margin-bottom: 8px;
            padding-left: 24px;
        }
        
        .bot-message li {
            margin-bottom: 6px;
        }

        .bot-message p {
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        /* Enhance bullets and numbering styles */
        .bot-message ul li {
            list-style-type: disc;
        }
        
        .bot-message ul li::marker {
            color: var(--primary-color);
        }
        
        .bot-message ol li::marker {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        /* Add link styling for map links - Simplified */
        .bot-message a[href*="google.com/maps"] {
            display: inline-block;
            color: var(--primary-color);
            font-weight: 500;
            text-decoration: none;
            padding: 5px 10px;
            background-color: var(--primary-light);
            border-radius: 6px;
            margin: 6px 0;
            transition: all 0.2s ease;
            font-size: 14px;
            min-width: 150px;
            text-align: center;
        }
        
        .bot-message a[href*="google.com/maps"]:hover {
            background-color: rgba(67, 97, 238, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .bot-message a[href*="google.com/maps"]::before {
            content: "🗺️ ";
            margin-right: 3px;
        }

        /* Simplified Location UI */
        .location-block {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        
        .location-name {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 3px;
        }
        
        .location-address {
            font-size: 14px;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        /* Page styles (not needed for widget itself) */
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #1f2937;
            line-height: 1.6;
        }
        h1 {
            color: var(--primary-color);
            font-weight: 700;
        }
        .content {
            line-height: 1.7;
        }

        /* Hidden utility class */
        .hidden {
            display: none !important;
        }

        /* Style for map links */
        .map-link, a.map-link {
            display: inline-block !important;
            width: 100% !important;
            margin: 10px 0 !important;
            padding: 12px !important;
            text-align: center !important;
            background-color: #0066cc !important;
            color: white !important;
            text-decoration: none !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 999 !important;
            position: relative !important;
        }
        
        .map-link:hover, a.map-link:hover {
            background-color: #0052a3 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
        }
        
        .location-block {
            margin-bottom: 20px;
            padding: 15px;
            background-color: transparent;
            border-radius: 0;
            border-left: none;
        }
        
        .location-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .location-address {
            margin-bottom: 10px;
        }

        /* iOS-specific fixes */
        @supports (-webkit-overflow-scrolling: touch) {
            /* iOS devices */
            .chat-window {
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
            
            /* Fix for iOS 100vh bug */
            @media (max-width: 480px) {
                .chat-window {
                    height: 85vh; /* Slightly smaller to account for Safari toolbar */
                    bottom: 70px;
                }
            }
            
            /* Additional iOS scrolling fix */
            .chat-messages, .booking-form {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>Anthill IQ Chatbot Test Page</h1>
        <p>This page demonstrates the Anthill IQ chatbot widget. Click the chat icon in the bottom right corner to start a conversation.</p>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <!-- Chat toggle button -->
        <button id="chat-toggle" class="chat-toggle" aria-label="Toggle chat">
            <span class="chat-toggle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
            </span>
        </button>

        <!-- Chat window -->
        <div id="chat-window" class="chat-window hidden">
            <!-- Chat header -->
            <div class="chat-header">
                <h3>Anthill IQ Assistant</h3>
                <button id="close-chat" class="close-button" aria-label="Close chat">×</button>
            </div>

            <!-- User registration form - initially visible -->
            <div id="user-registration-form" class="user-registration-form">
                <h4>Welcome to Anthill IQ</h4>
                <p>Please provide your details to continue</p>
                <form id="user-registration">
                    <input type="text" id="user-name" name="name" placeholder="Your Name *" required>
                    <input type="tel" id="user-phone" name="phone" placeholder="Your Phone Number (10 digits) *" pattern="[0-9]{10}" title="Please enter exactly 10 digits" required>
                    <button type="submit">Start Chat</button>
                </form>
            </div>

            <!-- Chat messages - initially hidden -->
            <div id="chat-messages" class="chat-messages hidden">
                <!-- Messages will be added here dynamically -->
                <!-- Typing indicator -->
                <div id="typing-indicator" class="typing-indicator">Anthill IQ Assistant is typing</div>
            </div>

            <!-- Booking form - hidden -->
            <div id="booking-form" class="booking-form hidden">
                <h4>Book a Service</h4>
                <form id="consultation-form">
                    <input type="text" id="name" name="name" placeholder="Your Name *" required>
                    <input type="email" id="email" name="email" placeholder="Your Email *" required>
                    <input type="tel" id="phone" name="phone" placeholder="Your Phone Number (10 digits) *" pattern="[0-9]{10}" title="Please enter exactly 10 digits" required>
                    
                    <select id="booking-location" required>
                        <option value="" disabled selected>Select Location</option>
                        <option value="Cunningham Road">Cunningham Road</option>
                        <option value="Hulimavu">Hulimavu</option>
                        <option value="Arekere">Arekere</option>
                        <option value="Hebbal">Hebbal</option>
                    </select>
                    
                    <select id="booking-type" required>
                        <option value="" disabled selected>Select Service</option>
                        <option value="Day Pass">Day Pass</option>
                        <option value="Private Office Space">Private Office Space</option>
                        <option value="Coworking Space">Coworking Space</option>
                        <option value="Dedicated Desk">Dedicated Desk</option>
                        <option value="Meeting Room">Meeting Room</option>
                        <option value="Event Space">Event Space</option>
                        <option value="Training Room">Training Room</option>
                    </select>
                    
                    <input type="number" id="seats" name="seats" placeholder="Number of Seats *" min="1" max="100" required>
                    <input type="datetime-local" id="datetime" required>
                    
                    <div class="booking-buttons">
                        <button type="submit" class="submit-button">Book Now</button>
                        <button type="button" id="back-button" onclick="backToServiceSelection()">Back</button>
                    <button type="button" id="cancel-booking">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Input area -->
            <div class="chat-input-area hidden" id="chat-input-area">
                <textarea id="chat-input" placeholder="Type your message..." rows="1"></textarea>
                <button id="send-message">
                    <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        /**
         * Anthill IQ Chatbot Widget
         * This script manages the chatbot interface for the Wix widget
         */

        // Configuration
        const CONFIG = {
            API_URL: 'http://192.168.1.19:8080/api/chat',
            BOOKING_API_URL: 'http://192.168.1.19:8080/api/booking',
            USER_REGISTRATION_API_URL: 'http://192.168.1.19:8080/api/register-user', // New endpoint for user registration
            INITIAL_MESSAGE: 'Hello! I\'m the Anthill IQ Assistant. How can I help you today?',
            CONTACT_NUMBER: '9119739119', // Updated contact number
            CONTACT_EMAIL: 'connect@anthilliq.com',
            BOOKING_KEYWORDS: [
                'book', 'reserve', 'schedule', 'appointment',
                'want to reserve', 'need to book', 'like to schedule',
                'book a desk', 'book an office', 'book a meeting room',
                'reserve a space', 'plan an event', 'book day pass',
                'day pass', 'book a day pass'
            ],
            SERVICES: [
                'Day Pass',
                'Private Office Space',
                'Coworking Space',
                'Dedicated Desk',
                'Meeting Room',
                'Event Space',
                'Training Room'
            ],
            LOCATIONS: [
                'Cunningham Road',
                'Hulimavu',
                'Arekere',
                'Hebbal'
            ]
        };

        // Get DOM elements
        const chatToggle = document.getElementById('chat-toggle');
        const chatWindow = document.getElementById('chat-window');
        const closeChat = document.getElementById('close-chat');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendMessage = document.getElementById('send-message');
        const bookingForm = document.getElementById('booking-form');
        const consultationForm = document.getElementById('consultation-form');
        const cancelBooking = document.getElementById('cancel-booking');
        // New elements for user registration
        const userRegistrationForm = document.getElementById('user-registration-form');
        const userRegistration = document.getElementById('user-registration');
        const userNameInput = document.getElementById('user-name');
        const userPhoneInput = document.getElementById('user-phone');

        // State management
        let sessionId = null;
        let isTyping = false;
        // Store user information globally
        let userData = {
            name: '',
            phone: ''
        };

        // Initialize the chat widget
        function initChatWidget() {
            // Set up event listeners
            chatToggle.addEventListener('click', toggleChat);
            closeChat.addEventListener('click', closeWidget);
            sendMessage.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', handleInputKeypress);
            consultationForm.addEventListener('submit', handleBookingSubmit);
            cancelBooking.addEventListener('click', hideBookingForm);
            
            // New event listener for user registration form
            userRegistration.addEventListener('submit', handleUserRegistration);
            
            // Auto-resize textarea as user types
            chatInput.addEventListener('input', autoResizeTextarea);
            
            // Add resize listener for responsive adjustments
            window.addEventListener('resize', handleResize);

            // Generate a unique session ID for this conversation
            sessionId = generateSessionId();
            console.log('Chat session initialized with ID:', sessionId);
        }

        // Generate a unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Toggle chat window visibility with zoom effects
        function toggleChat() {
            const isMobile = window.innerWidth <= 480;
            
            if (chatWindow.classList.contains('hidden')) {
                // Opening the chat window
                if (isMobile) {
                    // Mobile-specific animation
                    chatWindow.style.transform = 'translateY(100%)';
                    chatWindow.classList.remove('hidden');
                    
                    // Apply sliding animation
                    setTimeout(() => {
                        chatWindow.style.transform = 'translateY(0)';
                    }, 10);
                    
                    // Hide scroll on body when chat is open on mobile
                    document.body.style.overflow = 'hidden';
                } else {
                    // Desktop animation
                    chatWindow.style.transform = 'scale(0.8)';
                    chatWindow.classList.remove('hidden');
                    
                    // Apply zoom-in effect
                    setTimeout(() => {
                        chatWindow.style.transform = 'scale(1)';
                    }, 10);
                }
                
                // Focus on name input if registration form is visible
                if (!userRegistrationForm.classList.contains('hidden')) {
                    userNameInput.focus();
                } else {
                    chatInput.focus();
                }
                
                // Animation for the chat toggle
                chatToggle.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    chatToggle.style.transform = 'scale(1)';
                }, 200);
            } else {
                // Closing the chat window
                if (isMobile) {
                    // Mobile slide-down animation
                    chatWindow.style.transform = 'translateY(100%)';
                    
                    // Wait for animation to complete before hiding
                    setTimeout(() => {
                        chatWindow.classList.add('hidden');
                        // Restore body scroll when chat is closed
                        document.body.style.overflow = '';
                    }, 300);
                } else {
                    // Desktop zoom-out effect
                    chatWindow.style.transform = 'scale(0.8)';
                    
                    // Wait for animation to complete before hiding
                    setTimeout(() => {
                        chatWindow.classList.add('hidden');
                    }, 300);
                }
            }
        }

        // Close the chat widget with proper animation
        function closeWidget() {
            const isMobile = window.innerWidth <= 480;
            
            if (isMobile) {
                // Mobile slide-down animation
                chatWindow.style.transform = 'translateY(100%)';
                
                // Wait for animation to complete
                setTimeout(() => {
                    chatWindow.classList.add('hidden');
                    // Restore body scroll
                    document.body.style.overflow = '';
                }, 300);
            } else {
                // Desktop zoom-out effect
                chatWindow.style.transform = 'scale(0.8)';
                
                // Wait for animation to complete
                setTimeout(() => {
                    chatWindow.classList.add('hidden');
                }, 300);
            }
        }

        // Handle user registration form submission
        async function handleUserRegistration(event) {
            event.preventDefault();
            
            // Get form values
            const name = userNameInput.value.trim();
            const phone = userPhoneInput.value.trim();
            
            // Validate form
            if (!name || !phone) {
                alert('Please fill out both name and phone number fields.');
                return;
            }
            
            // Validate phone number has exactly 10 digits
            if (!/^\d{10}$/.test(phone)) {
                alert('Please enter a valid 10-digit phone number.');
                return;
            }
            
            // Store user data globally
            userData.name = name;
            userData.phone = phone;
            
            try {
                // Prepare user data
                const userRegistrationData = {
                    name: name,
                    phone: phone,
                    timestamp: new Date().toISOString(),
                    source: 'chatbot_widget',
                    session_id: sessionId // Include the session ID
                };
                
                // Send registration to backend
                const response = await fetch(CONFIG.USER_REGISTRATION_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userRegistrationData)
                }).catch(error => {
                    console.error('Error sending user registration:', error);
                    // If API call fails, still allow chat to proceed
                    // This ensures the widget works even if there are backend issues
                });
                
                // Hide the registration form and show the chat interface
                userRegistrationForm.classList.add('hidden');
                chatMessages.classList.remove('hidden');
                document.getElementById('chat-input-area').classList.remove('hidden');
                
                // Pre-fill the booking form with user data for convenience
                document.getElementById('name').value = name;
                document.getElementById('phone').value = phone;
                
                // Show initial message
                appendMessage(CONFIG.INITIAL_MESSAGE, 'bot', 'welcome');
                
                // Focus on chat input
                chatInput.focus();
                
                // Log registration for debugging
                console.log('User registered:', userRegistrationData);
                
            } catch (error) {
                console.error('Error processing user registration:', error);
                // Even if there's an error, allow the chat to proceed
                userRegistrationForm.classList.add('hidden');
                chatMessages.classList.remove('hidden');
                document.getElementById('chat-input-area').classList.remove('hidden');
                appendMessage(CONFIG.INITIAL_MESSAGE, 'bot', 'welcome');
                chatInput.focus();
            }
        }

        // Show the booking form
        function showBookingForm() {
            // Get selected service and location
            const selectedService = document.getElementById('booking-type').value;
            const selectedLocation = document.getElementById('booking-location').value;
            
            // Update booking form title to reflect the selection
            const formTitle = document.querySelector('.booking-form h4');
            if (formTitle) {
                formTitle.textContent = `Book a ${selectedService} at ${selectedLocation}`;
            }
            
            // Make location and service select elements readonly since they're already selected
            document.getElementById('booking-location').disabled = true;
            document.getElementById('booking-type').disabled = true;
            
            // Prefill with user data if available
            if (userData.name) {
                document.getElementById('name').value = userData.name;
            }
            if (userData.phone) {
                document.getElementById('phone').value = userData.phone;
            }
            
            // Clear other form data
            document.getElementById('email').value = '';
            document.getElementById('datetime').value = '';
            
            // Add guidance message before showing the form
            appendMessage(`Great choice! A ${selectedService} at our ${selectedLocation} branch is an excellent selection.`, 'bot', 'booking_intro');
            
            // Add a short delay for a more natural conversation flow
            setTimeout(() => {
                // Add specific guidance for filling out the form
                appendMessage(`Please fill out the form below with your contact details and preferred date and time. Our team will reach out to confirm your booking shortly.

Need help? You can go back to select a different service, or cancel the booking process at any time.`, 'bot', 'booking_guidance');
                
                // Make the form visible after message
                setTimeout(() => {
                    bookingForm.classList.remove('hidden');
                    chatInput.disabled = true;
                    sendMessage.disabled = true;
                    
                    // Focus on the email field since name and phone are prefilled
                    document.getElementById('email').focus();
                }, 500);
            }, 800);
        }

        // Hide the booking form
        function hideBookingForm() {
            bookingForm.classList.add('hidden');
            chatInput.disabled = false;
            sendMessage.disabled = false;
            chatInput.focus();
            
            // Re-enable location and service select
            document.getElementById('booking-location').disabled = false;
            document.getElementById('booking-type').disabled = false;
            
            // Add a message informing the user they can continue the conversation
            appendMessage("Booking form closed. You can continue the conversation or ask about our services.", 'bot', 'form_closed');
        }
        
        // Go back from booking form to service selection
        function backToServiceSelection() {
            // Hide booking form first
            bookingForm.classList.add('hidden');
            chatInput.disabled = false;
            sendMessage.disabled = false;
            
            // Re-enable the select elements
            document.getElementById('booking-location').disabled = false;
            document.getElementById('booking-type').disabled = false;
            
            // Get the selected location
            const selectedLocation = document.getElementById('booking-location').value;
            
            // Add a message about going back
            appendMessage("I'd like to select a different service", 'user');
            
            // Show service options again
            setTimeout(() => {
                appendMessage("No problem, let's choose a different service.", 'bot', 'booking_flow');
                showServiceOptions(selectedLocation);
            }, 500);
        }

        // Make URL clickable and properly formatted
        function makeLinksClickable(text) {
            // Regular expression to match URLs
            const urlRegex = /(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/g;
            
            // Replace URLs with anchor tags
            return text.replace(urlRegex, function(url) {
                let href = url;
                if (url.indexOf('http') !== 0) {
                    href = 'https://' + url;
                }
                
                // Simplified display for long Google Maps URLs
                if (href.includes('google.com/maps')) {
                    return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="map-link">Get Directions</a>`;
                }
                
                return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
        }
        
        // Format location information with a cleaner UI
        function formatLocationInfo(text) {
            // Check if text contains location information keywords
            if (!text.includes('Cunningham Road') && 
                !text.includes('Arekere') && 
                !text.includes('Hulimavu') && 
                !text.includes('Hebbal')) {
                return text;
            }
            
            // If the message specifically includes address information, preserve it
            if (text.includes("Anthill IQ Workspace Locations") || 
                text.includes("1st Floor, Anthill IQ") || 
                text.includes("224, Bannerghatta Rd") || 
                text.includes("75/B Windsor F4")) {
                
                // Format but preserve addresses
                return text
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
            }
            
            // Otherwise, do the simple location formatting
            const sections = text.split('\n\n');
            let formattedText = '';
            
            for (let section of sections) {
                // Check if this section is about locations
                if (section.includes('Cunningham Road') || 
                    section.includes('Arekere') || 
                    section.includes('Hulimavu') || 
                    section.includes('Hebbal')) {
                    
                    // Only keep the location names, remove addresses and directions
                    if (section.includes('1. Cunningham Road') || section.includes('Cunningham Road')) {
                        formattedText += '1. Cunningham Road (Central Bangalore)\n\n';
                    }
                    
                    if (section.includes('2. Arekere') || section.includes('Arekere')) {
                        formattedText += '2. Arekere (South Bangalore)\n\n';
                    }
                    
                    if (section.includes('3. Hulimavu') || section.includes('Hulimavu')) {
                        formattedText += '3. Hulimavu (South Bangalore)\n\n';
                    }
                    
                    if (section.includes('4. Hebbal') || section.includes('Hebbal')) {
                        formattedText += '4. Hebbal (North Bangalore - Opening Soon)\n\n';
                    }
                    
                    // Add a generic message about booking
                    if (formattedText && !formattedText.includes('You can select')) {
                        formattedText += 'You can select any of these locations when booking through our website or this chatbot.';
                    }
                } else {
                    // Keep other sections as they are
                    formattedText += section + '\n\n';
                }
            }
            
            return formattedText.trim();
        }

        // Append a message to the chat
        function appendMessage(text, sender, source = '') {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            
            const message = document.createElement('div');
            message.className = `message ${sender}-message`;
            
            // Make sure URLs are clickable
            let processedText = makeLinksClickable(text);
            
            // Format location information if present
            if (sender === 'bot') {
                processedText = formatLocationInfo(processedText);
            }
            
            // Convert line breaks to <br> tags and handle lists
            let formattedText = processedText.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
            
            // Handle bulleted lists (lines starting with • or *)
            formattedText = formattedText.replace(/(?:^|\<br\>)([\s]*?)([•\*\-])\s+(.*?)(?=(?:\<br\>|$))/g, function(match, space, bullet, item) {
                return (space ? '<br>' : '') + '<ul><li>' + item + '</li></ul>';
            });
            
            // Combine adjacent list items
            formattedText = formattedText.replace(/<\/ul>\s*<ul>/g, '');
            
            // Handle numbered lists (lines starting with 1., 2., etc.)
            formattedText = formattedText.replace(/(?:^|\<br\>)([\s]*?)(\d+)\.?\s+(.*?)(?=(?:\<br\>|$))/g, function(match, space, number, item) {
                return (space ? '<br>' : '') + '<ol start="' + number + '"><li>' + item + '</li></ol>';
            });
            
            // Combine adjacent numbered list items
            formattedText = formattedText.replace(/<\/ol>\s*<ol start="\d+">/g, '');
            
            // Special formatting for Google Maps links - create buttons
            formattedText = formattedText.replace(/<a href="(https:\/\/www\.google\.com\/maps\/[^"]+)"[^>]*>[^<]+<\/a>/g, 
                '<a href="$1" target="_blank" rel="noopener noreferrer" class="map-link">Get Directions</a>');
                
            // Fix for broken directions links
            formattedText = formattedText.replace(/Directions: <a href="([^"]+)" target="_blank" rel="noopener noreferrer" class="map-link">Get Directions<\/a>/g,
                'Directions: <a href="$1" target="_blank" rel="noopener noreferrer" class="map-link">Get Directions</a>');
                
            formattedText = formattedText.replace(/Get Directions" target="_blank" rel="noopener noreferrer" class="map-link">Get Directions/g,
                'Get Directions</a>');
                
            // Fix any potential double quotes
            formattedText = formattedText.replace(/"Get Directions"><\/a>/g, '>Get Directions</a>');
            
            // Wrap in paragraph tags if not already wrapped and doesn't contain custom elements
            if (!formattedText.match(/^<p>/) && !formattedText.match(/^<ul>/) && !formattedText.match(/^<ol>/) && !formattedText.match(/^<div class="location-block"/)) {
                formattedText = '<p>' + formattedText + '</p>';
            }
            
            message.innerHTML = formattedText;
            
            // Add source indicator for bot messages (debug only - hidden)
            if (sender === 'bot' && source) {
                const sourceSpan = document.createElement('span');
                sourceSpan.className = 'message-source hidden';
                sourceSpan.textContent = source;
                sourceSpan.style.display = 'none'; // Hide the source label
                message.appendChild(sourceSpan);
            }
            
            messageWrapper.appendChild(message);
            
            const clearfix = document.createElement('div');
            clearfix.className = 'clearfix';
            messageWrapper.appendChild(clearfix);
            
            chatMessages.appendChild(messageWrapper);
            
            // Add click listeners for maps links
            message.querySelectorAll('a[href*="google.com/maps"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    // Optional: track map link clicks
                    console.log('Map link clicked:', link.href);
                });
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Check if a message contains booking intent
        function containsBookingIntent(message) {
            const lowerMessage = message.toLowerCase();
            
            // First check if it's just a service inquiry
            const serviceInquiryPatterns = [
                "what are the services", 
                "what services do you offer",
                "tell me about your services",
                "services that anthill",
                "what does anthill offer",
                "what does anthill provide"
            ];
            
            // If it's a pure service inquiry, don't trigger booking flow
            if (serviceInquiryPatterns.some(pattern => lowerMessage.includes(pattern))) {
                return false;
            }
            
            // Then check for booking keywords
            return CONFIG.BOOKING_KEYWORDS.some(keyword => lowerMessage.includes(keyword.toLowerCase()));
        }

        // Add quick reply buttons
        function addQuickReplies(options) {
            const container = document.createElement('div');
            container.className = 'message-wrapper';
            
            const message = document.createElement('div');
            message.className = 'message bot-message';
            message.textContent = 'What service would you like to book?';
            
            const repliesDiv = document.createElement('div');
            repliesDiv.className = 'quick-replies';
            
            // Add service options
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quick-reply-button';
                button.textContent = option;
                button.addEventListener('click', () => {
                    // Set form field if it exists
                    const typeField = document.getElementById('booking-type');
                    if (typeField) {
                        // Set the value for the select element
                        const optionElement = Array.from(typeField.options).find(opt => opt.text === option);
                        if (optionElement) {
                            typeField.value = optionElement.value;
                        }
                    }
                    
                    // Show booking form
                    showBookingForm();
                    
                    // Send a message as user
                    appendMessage(`I'd like to book a ${option}`, 'user');
                });
                repliesDiv.appendChild(button);
            });
            
            // Add a cancel button
            const cancelButton = document.createElement('button');
            cancelButton.className = 'quick-reply-button cancel';
            cancelButton.textContent = 'Cancel';
            cancelButton.addEventListener('click', () => {
                // Remove the quick reply options
                container.remove();
                
                // Send a message as user
                appendMessage("I don't want to book right now, just exploring options", 'user');
                
                // Bot response acknowledging cancellation
                setTimeout(() => {
                    appendMessage("No problem! Feel free to ask if you have any other questions about our services or locations. I'm here to help.", 'bot', 'cancellation');
                }, 500);
            });
            repliesDiv.appendChild(cancelButton);
            
            message.appendChild(repliesDiv);
            container.appendChild(message);
            
            const clearfix = document.createElement('div');
            clearfix.className = 'clearfix';
            container.appendChild(clearfix);
            
            chatMessages.appendChild(container);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            // Check if typing indicator already exists
            if (document.getElementById('typing-indicator')) {
                return; // Exit if indicator already exists
            }
            
            isTyping = true;
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'typing-indicator';
            indicator.textContent = 'Anthill IQ is typing';
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Make typing indicator visible with display block
            indicator.style.display = 'block';
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Auto-resize textarea as user types
        function autoResizeTextarea() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min((chatInput.scrollHeight), 120) + 'px';
        }

        // Handle sending a message
        async function handleSendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            appendMessage(userMessage, 'user');
            showTypingIndicator();

            // Check for direct booking keywords first
            const lowerMessage = userMessage.toLowerCase();
            if (lowerMessage.includes('day pass') || lowerMessage.includes('daypass')) {
                hideTypingIndicator();
                startBookingFlow('Day Pass');
                return;
            }
            
            try {
                // Prepare request data
                const requestData = {
                    message: userMessage,
                    session_id: sessionId
                };
                
                // Send request to API
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const result = await response.json();
                
                if (result.session_id) {
                    sessionId = result.session_id;
                }
                
                hideTypingIndicator();
                
                // Check if response indicates booking intent
                if (result.should_start_booking || result.response.toLowerCase().includes('book') || result.response.toLowerCase().includes('schedule')) {
                    appendMessage(result.response, 'bot', result.source || 'api');
                    setTimeout(() => {
                        startBookingFlow();
                    }, 1000);
                } else {
                    appendMessage(result.response, 'bot', result.source || 'api');
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                appendMessage('I am here to help! Please feel free to ask any questions about our services, locations, or booking options.', 'bot', 'error');
            }
        }
        
        // Ask if user wants to book a service
        function askAboutBooking() {
            appendMessage("Would you like to book any of these services?", 'bot', 'booking_prompt');
            
            // Create Yes/No buttons
            const container = document.createElement('div');
            container.className = 'message-wrapper';
            
            const message = document.createElement('div');
            message.className = 'message bot-message';
            
            const repliesDiv = document.createElement('div');
            repliesDiv.className = 'quick-replies';
            
            // Yes button
            const yesButton = document.createElement('button');
            yesButton.className = 'quick-reply-button';
            yesButton.textContent = 'Yes, I want to book';
            yesButton.addEventListener('click', () => {
                container.remove();
                appendMessage("Yes, I'd like to book a service", 'user');
                setTimeout(() => {
                    startBookingFlow();
                }, 500);
            });
            repliesDiv.appendChild(yesButton);
            
            // No button
            const noButton = document.createElement('button');
            noButton.className = 'quick-reply-button cancel';
            noButton.textContent = 'Not right now';
            noButton.addEventListener('click', () => {
                container.remove();
                appendMessage("Not right now, thanks", 'user');
                setTimeout(() => {
                    appendMessage("No problem! Feel free to ask if you have any other questions about our services or locations.", 'bot', 'info');
                }, 500);
            });
            repliesDiv.appendChild(noButton);
            
            message.appendChild(repliesDiv);
            container.appendChild(message);
            
            const clearfix = document.createElement('div');
            clearfix.className = 'clearfix';
            container.appendChild(clearfix);
            
            chatMessages.appendChild(container);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Start the booking flow - Step 1: Select location
        function startBookingFlow(preselectedService = null) {
            if (preselectedService) {
                // Set the service in the form
                const serviceField = document.getElementById('booking-type');
                if (serviceField) {
                    serviceField.value = preselectedService;
                }
                appendMessage("Great! You'd like to book a " + preselectedService + ". First, please select a location:", 'bot', 'booking_flow');
            } else {
                appendMessage("Let's start the booking process. First, please select a location:", 'bot', 'booking_flow');
            }
            
            showLocationOptions(preselectedService);
        }
        
        // Show location selection options
        function showLocationOptions(preselectedService = null) {
            const container = document.createElement('div');
            container.className = 'message-wrapper';
            
            const message = document.createElement('div');
            message.className = 'message bot-message';
            
            const repliesDiv = document.createElement('div');
            repliesDiv.className = 'quick-replies';
            
            // Add location options
            CONFIG.LOCATIONS.forEach(location => {
                const button = document.createElement('button');
                button.className = 'quick-reply-button';
                button.textContent = location;
                button.addEventListener('click', () => {
                    container.remove();
                    appendMessage(`I want to book at ${location}`, 'user');
                    
                    let locationField = document.getElementById('booking-location');
                    if (locationField) {
                        locationField.value = location;
                    }
                    
                    setTimeout(() => {
                        if (preselectedService) {
                            showBookingForm();
                        } else {
                            showServiceOptions(location);
                        }
                    }, 500);
                });
                repliesDiv.appendChild(button);
            });
            
            // Add cancel button
            const cancelButton = document.createElement('button');
            cancelButton.className = 'quick-reply-button cancel';
            cancelButton.textContent = 'Cancel';
            cancelButton.addEventListener('click', () => {
                container.remove();
                appendMessage("I want to cancel booking", 'user');
                setTimeout(() => {
                    appendMessage("No problem! The booking process has been cancelled. Is there anything else you'd like to know about Anthill IQ?", 'bot', 'cancellation');
                }, 500);
            });
            repliesDiv.appendChild(cancelButton);
            
            message.appendChild(repliesDiv);
            container.appendChild(message);
            
            const clearfix = document.createElement('div');
            clearfix.className = 'clearfix';
            container.appendChild(clearfix);
            
            chatMessages.appendChild(container);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show service selection options
        function showServiceOptions(selectedLocation) {
            appendMessage(`Great! Now please select a service at our ${selectedLocation} location:`, 'bot', 'booking_flow');
            
            const container = document.createElement('div');
            container.className = 'message-wrapper';
            
            const message = document.createElement('div');
            message.className = 'message bot-message';
            
            const repliesDiv = document.createElement('div');
            repliesDiv.className = 'quick-replies';
            
            // Add service options
            CONFIG.SERVICES.forEach(service => {
                const button = document.createElement('button');
                button.className = 'quick-reply-button';
                button.textContent = service;
                button.addEventListener('click', () => {
                    container.remove();
                    appendMessage(`I want to book a ${service}`, 'user');
                    
                    // Save selected service in a hidden field
                    let serviceField = document.getElementById('booking-type');
                    if (serviceField) {
                        serviceField.value = service;
                    }
                    
                    // Show booking form
                    setTimeout(() => {
                        showBookingForm();
                    }, 500);
                });
                repliesDiv.appendChild(button);
            });
            
            // Back button
            const backButton = document.createElement('button');
            backButton.className = 'quick-reply-button';
            backButton.style.backgroundColor = '#6c757d';
            backButton.textContent = 'Back';
            backButton.addEventListener('click', () => {
                container.remove();
                appendMessage("I want to select a different location", 'user');
                setTimeout(() => {
                    appendMessage("No problem, let's choose a different location.", 'bot', 'booking_flow');
                    showLocationOptions();
                }, 500);
            });
            repliesDiv.appendChild(backButton);
            
            // Cancel button
            const cancelButton = document.createElement('button');
            cancelButton.className = 'quick-reply-button cancel';
            cancelButton.textContent = 'Cancel';
            cancelButton.addEventListener('click', () => {
                container.remove();
                appendMessage("I want to cancel booking", 'user');
                setTimeout(() => {
                    appendMessage("No problem! The booking process has been cancelled. Is there anything else you'd like to know about Anthill IQ?", 'bot', 'cancellation');
                }, 500);
            });
            repliesDiv.appendChild(cancelButton);
            
            message.appendChild(repliesDiv);
            container.appendChild(message);
            
            const clearfix = document.createElement('div');
            clearfix.className = 'clearfix';
            container.appendChild(clearfix);
            
            chatMessages.appendChild(container);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle input keypress (send message on Enter)
        function handleInputKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSendMessage();
            }
        }

        // Handle booking form submission
        async function handleBookingSubmit(event) {
            event.preventDefault();
            
            // Get form values
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const bookingType = document.getElementById('booking-type').value;
            const location = document.getElementById('booking-location').value;
            const seats = document.getElementById('seats').value;
            const datetime = document.getElementById('datetime').value;
            
            // Validate form
            if (!name || !email || !phone || !datetime || !bookingType || !location || !seats) {
                alert('Please fill out all required fields.');
                return;
            }
            
            // Validate phone number has exactly 10 digits
            if (!/^\d{10}$/.test(phone)) {
                alert('Please enter a valid 10-digit phone number.');
                return;
            }
            
            // Extract date and time
            const date = datetime.split('T')[0];
            const time = datetime.split('T')[1];
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Prepare booking data
                const bookingData = {
                    name: name,
                    email: email,
                    phone: phone,
                    service: bookingType,
                    location: location,
                    seats: seats,
                    datetime: `${date} ${time}`,
                    message: `Booking for ${bookingType} at ${location} (${seats} seats) on ${date} at ${time}`,
                    status: 'Pending',
                    source: 'chatbot_widget',
                    notes: 'Submitted through chatbot widget'
                };
                
                // Send booking request
                const response = await fetch(CONFIG.BOOKING_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });
                
                // Parse response
                const result = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Hide booking form but leave the button accessible for future use
                bookingForm.classList.add('hidden');
                chatInput.disabled = false;
                sendMessage.disabled = false;
                
                // Re-enable the select elements for future bookings
                document.getElementById('booking-location').disabled = false;
                document.getElementById('booking-type').disabled = false;
                
                // Format date for display
                const formattedDate = new Date(date).toLocaleDateString();
                
                // Add first confirmation message
                appendMessage(`Great! I've received your booking request, ${name}. 😊`, 'bot', 'booking');
                
                // Add details after a short delay - more conversational approach
                setTimeout(() => {
                    appendMessage(`Here's a summary of your booking:
                    
• Service: ${bookingType}
• Location: ${location} branch
• Number of Seats: ${seats}
• Date: ${formattedDate}
• Time: ${time}
• Contact: ${email} / ${phone}

Our team will reach out to you very soon to confirm your booking details. If you need to make any changes or have questions, just let me know!

Is there anything else I can help you with today?`, 'bot', 'booking_confirmation');
                }, 1000);
                
                // Reset form for future use
                document.getElementById('name').value = '';
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('seats').value = '';
                document.getElementById('datetime').value = '';
                
                // Don't reset the select elements completely, just enable them
                chatInput.focus();
                
                // Log successful booking for analytics
                console.log('Booking successfully submitted:', bookingData);
                
            } catch (error) {
                console.error('Error submitting booking:', error);
                hideTypingIndicator();
                
                // Re-enable submit button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Book Now';
                }
                
                appendMessage(`Sorry, there was an error processing your booking. Please try again later or contact us directly at ${CONFIG.CONTACT_NUMBER} or ${CONFIG.CONTACT_EMAIL}.`, 'bot', 'error');
                hideBookingForm();
            }
        }

        // Improve service inquiry handling
        function handleServiceInquiry(message) {
            const serviceInquiryPatterns = [
                "what are the services",
                "what services do you offer",
                "tell me about your services",
                "services that anthill",
                "what does anthill offer",
                "what does anthill provide"
            ];

            const lowerMessage = message.toLowerCase();
            if (serviceInquiryPatterns.some(pattern => lowerMessage.includes(pattern))) {
                return `Here are the comprehensive services offered by Anthill IQ:

1. Private Office Space
   • Fully furnished private offices
   • Secure, dedicated workspace
   • Customizable to your team size
   • 24/7 access
   • High-speed internet
   • Complimentary beverages

2. Coworking Space
   • Flexible hot desks
   • Vibrant community atmosphere
   • High-speed internet
   • Access to common areas
   • Networking opportunities
   • Complimentary beverages

3. Dedicated Desk
   • Your personal fixed desk
   • Ergonomic chair
   • Storage space
   • 24/7 access
   • High-speed internet
   • Business address usage

4. Meeting Rooms
   • Professional meeting spaces
   • HD video conferencing
   • Whiteboard and projector
   • Catering options available
   • Various room sizes
   • Hourly booking options

5. Event Spaces
   • Versatile event venues
   • AV equipment
   • Flexible seating arrangements
   • Catering services
   • Perfect for workshops & seminars
   • Professional event support

6. Training Room
   • Classroom-style setup
   • Interactive presentation tools
   • Breakout areas
   • Catering options
   • Technical support
   • Flexible configurations

All our existing locations (Cunningham Road, Hulimavu, and Arekere) offer these services with state-of-the-art facilities and amenities. We're also excited to announce our upcoming new branch in Hebbal, opening soon!

For pricing information, please contact us at ${CONFIG.CONTACT_NUMBER} or ${CONFIG.CONTACT_EMAIL}.

Would you like to know more about any specific service or would you like to book one?`;
            }
            return null;
        }

        // Add pricing query handler
        function handlePricingQuery(message) {
            const pricingPatterns = [
                "pricing",
                "price",
                "cost",
                "how much",
                "rates",
                "fee",
                "charges",
                "package"
            ];

            const lowerMessage = message.toLowerCase();
            if (pricingPatterns.some(pattern => lowerMessage.includes(pattern))) {
                return `Thank you for your interest in our pricing!

Our pricing varies based on location, service type, and duration. Each of our branches (Cunningham Road, Arekere, Hulimavu, and our upcoming Hebbal branch) offers customized packages designed to meet your specific needs.

For detailed pricing information, please contact us directly:
• Phone: ${CONFIG.CONTACT_NUMBER}
• Email: ${CONFIG.CONTACT_EMAIL}

Our team will be happy to provide you with current rates and help you find the perfect solution for your requirements. We often have special promotions and flexible packages available.

Would you like me to help you connect with our team for pricing details?`;
            }
            return null;
        }

        // Handle window resize events
        function handleResize() {
            const isMobile = window.innerWidth <= 480;
            
            if (!chatWindow.classList.contains('hidden')) {
                // Adjust chat window position when visible
                if (isMobile) {
                    chatWindow.style.transform = 'translateY(0)';
                    document.body.style.overflow = 'hidden';
                } else {
                    chatWindow.style.transform = 'scale(1)';
                    document.body.style.overflow = '';
                }
            }
            
            // Force scroll to bottom of messages on resize
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Initialize the widget when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initChatWidget);
    </script>
</body>
</html> 